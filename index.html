
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Endless Grinder</title>
    <style>
        :root {
            --bg-color: #1a1a2e; /* Dark blue-black background */
            --card-bg: #2e2e5c; /* Deep purple card */
            --text-color: #f0f0f0; /* Off-white text */
            --primary-color: #5c67f2; /* A brighter purple for accents/buttons */
            --progress-bar-color: #4d9de0; /* Light blue for progress */
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --star-color: #f9d71c;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
        }

        .page-container {
            width: 100%;
            max-width: 420px;
            background-color: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .hidden { display: none !important; }

        /* --- Utility Controls --- */
        .utility-controls { position: absolute; top: 15px; right: 20px; }
        .utility-btn {
            padding: 5px 12px; font-size: 0.85rem; color: #aab;
            background-color: transparent; border: 1px solid #556;
            border-radius: 20px; cursor: pointer; transition: all 0.2s ease;
        }
        .utility-btn:hover { background-color: #445; border-color: #889; }
        
        /* --- Main Menu Page --- */
        #menu-page { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; min-height: 500px; }
        .menu-title { font-size: 2.5rem; color: white; margin-bottom: 0; }
        .menu-subtitle { margin-top: 10px; color: #aab; }
        #start-btn {
            padding: 15px 30px; font-size: 1.5rem; border: none;
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
            width: 80%; margin-top: 20px; background-color: var(--primary-color); color: white;
            box-shadow: 0 4px 15px rgba(92, 103, 242, 0.4);
        }
        #start-btn:hover { background-color: #4a54c4; transform: translateY(-2px); }
        
        /* --- Quiz Page --- */
        #quiz-page { min-height: 500px; display: flex; flex-direction: column; }
        
        #overall-progress-container {
            width: 100%; height: 8px; background-color: rgba(0,0,0,0.2);
            border-radius: 4px; overflow: hidden; margin-bottom: 20px;
        }
        #overall-progress-bar {
            height: 100%; width: 0%; background-color: var(--progress-bar-color);
            border-radius: 4px; transition: width 0.5s ease;
        }
        
        #progress-bar {
            font-size: 1.6rem; color: var(--star-color);
            margin-bottom: 15px; opacity: 0.8; letter-spacing: 2px;
        }
        
        #character-display {
            font-size: 10rem; font-weight: 500; color: white;
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
        }
        
        #options-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .option-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.2);
            background-color: transparent; color: rgba(255, 255, 255, 0.8);
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s ease;
        }
        .option-btn:hover:not(:disabled) { border-color: rgba(255, 255, 255, 0.8); background-color: rgba(255, 255, 255, 0.1); }
        .option-btn.correct { background-color: var(--correct-color); border-color: var(--correct-color); color: white; }
        .option-btn.incorrect { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: white; }
        .option-btn.highlight { border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); }
        
        /* Progress Modal */
        .modal-overlay { z-index: 100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .progress-modal { background: var(--card-bg); color: var(--text-color); padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        #progress-table { width: 100%; border-collapse: collapse; }
        #progress-table th, #progress-table td { padding: 10px; text-align: center; border-bottom: 1px solid #445; }
        #progress-table th { font-weight: bold; color: white; }
        .kana-char { font-size: 1.5rem; }
        .star-display { color: var(--star-color); letter-spacing: 1px;}
    </style>
</head>
<body>

    <!-- PAGE 1: MAIN MENU -->
    <div id="menu-page" class="page-container">
        <div class="utility-controls"><button id="utility-progress-btn" class="utility-btn">Progress</button></div>
        <h1 class="menu-title">Hiragana Grinder</h1>
        <p class="menu-subtitle">Endlessly practice your Hiragana.</p>
        <button id="start-btn">Start Learning</button>
    </div>

    <!-- PAGE 2: QUIZ -->
    <div id="quiz-page" class="page-container hidden">
        <div class="utility-controls"><button id="utility-menu-btn" class="utility-btn">Menu</button></div>
        <div id="overall-progress-container"><div id="overall-progress-bar"></div></div>
        <div id="progress-bar"></div>
        <div id="character-display"></div>
        <div id="options-container"></div>
    </div>

    <!-- MODAL (RESTORED) -->
    <div id="progress-modal-overlay" class="modal-overlay">
        <div class="progress-modal">
            <h2>Your Progress</h2>
            <table id="progress-table">
                <thead>
                    <tr><th>Hiragana</th><th>Romaji</th><th>Stars</th></tr>
                </thead>
                <tbody>
                    <!-- Content will be generated by JS -->
                </tbody>
            </table>
            <button id="close-modal-btn" class="utility-btn" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const kanaGroups = [ ['あ','い','う','え','お'], ['か','き','く','け','こ','が','ぎ','ぐ','げ','ご'], ['さ','し','す','せ','そ','ざ','じ','ず','ぜ','ぞ'], ['た','ち','つ','て','と','だ','ぢ','づ','で','ど'], ['な','に','ぬ','ね','の'], ['は','ひ','ふ','へ','ほ','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'], ['ま','み','む','め','も'], ['や','ゆ','よ'], ['ら','り','る','れ','ろ'], ['わ','を'], ['ん'] ];
            const romajiMap = { 'あ':'a', 'い':'i', 'う':'u', 'え':'e', 'お':'o', 'か':'ka', 'き':'ki', 'く':'ku', 'け':'ke', 'こ':'ko', 'さ':'sa', 'し':'shi', 'す':'su', 'せ':'se', 'そ':'so', 'た':'ta', 'ち':'chi', 'つ':'tsu', 'て':'te', 'と':'to', 'な':'na', 'に':'ni', 'ぬ':'nu', 'ね':'ne', 'の':'no', 'は':'ha', 'ひ':'hi', 'ふ':'fu', 'へ':'he', 'ほ':'ho', 'ま':'ma', 'み':'mi', 'む':'mu', 'め':'me', 'も':'mo', 'や':'ya', 'ゆ':'yu', 'よ':'yo', 'ら':'ra', 'り':'ri', 'る':'ru', 'れ':'re', 'ろ':'ro', 'わ':'wa', 'を':'wo', 'ん':'n', 'が':'ga', 'ぎ':'gi', 'ぐ':'gu', 'げ':'ge', 'ご':'go', 'ざ':'za', 'じ':'ji', 'ず':'zu', 'ぜ':'ze', 'ぞ':'zo', 'だ':'da', 'ぢ':'ji', 'づ':'zu', 'で':'de', 'ど':'do', 'ば':'ba', 'び':'bi', 'ぶ':'bu', 'べ':'be', 'ぼ':'bo', 'ぱ':'pa', 'ぴ':'pi', 'ぷ':'pu', 'ぺ':'pe', 'ぽ':'po' };
            const allKana = kanaGroups.flat();

            // --- DOM ELEMENTS ---
            const menuPage = document.getElementById('menu-page'), quizPage = document.getElementById('quiz-page'), startBtn = document.getElementById('start-btn'), utilityProgressBtn = document.getElementById('utility-progress-btn'), utilityMenuBtn = document.getElementById('utility-menu-btn'), charDisplay = document.getElementById('character-display'), optionsContainer = document.getElementById('options-container'), progressBar = document.getElementById('progress-bar'), overallProgressBar = document.getElementById('overall-progress-bar'), modalOverlay = document.getElementById('progress-modal-overlay'), closeModalBtn = document.getElementById('close-modal-btn'), progressTableBody = document.querySelector('#progress-table tbody');

            // --- STATE ---
            let state = { progress: {}, unlockedKanaCount: 5, isAnswering: false, lastKana: null };
            
            // --- TTS WITH FALLBACK ---
            const synth = window.speechSynthesis;
            const speakWithWebSpeechAPI = text => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.8; synth.speak(u); };
            const speak = text => { const a = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=ja&client=tw-ob`); a.play().catch(() => speakWithWebSpeechAPI(text)); };

            // --- PAGE MGMT ---
            const showMenuPage = () => { quizPage.classList.add('hidden'); menuPage.classList.remove('hidden'); };
            const showQuizPage = () => { menuPage.classList.add('hidden'); quizPage.classList.remove('hidden'); generateQuestion(); };

            // --- CORE LOGIC ---
            const loadProgress = () => { const s = JSON.parse(localStorage.getItem('hP')); if (s) { state.progress = s.p || {}; state.unlockedKanaCount = s.uKC || 5; } allKana.forEach(k => { if (state.progress[k] === undefined) state.progress[k] = 0; }); };
            const saveProgress = () => { localStorage.setItem('hP', JSON.stringify({ p: state.progress, uKC: state.unlockedKanaCount })); };

            const unlockNextKana = () => {
                const lastUnlockedKana = allKana[state.unlockedKanaCount - 1];
                if (state.progress[lastUnlockedKana] >= 5 && state.unlockedKanaCount < allKana.length) {
                    state.unlockedKanaCount++;
                    saveProgress();
                }
            };

            const updateOverallProgress = () => { const t = Object.values(state.progress).reduce((s, v) => s + v, 0), m = allKana.length * 10; overallProgressBar.style.width = `${m > 0 ? t / m * 100 : 0}%`; };

            function generateQuestion() {
                updateOverallProgress();
                const unlockedKana = allKana.slice(0, state.unlockedKanaCount);
                let weightedPool = unlockedKana.flatMap(k => { const s = state.progress[k]; if (s === 10) return Math.random() < 0.05 ? [k] : []; return Array(11 - s).fill(k); });
                if (weightedPool.length === 0) weightedPool.push(...unlockedKana);
                let currentKana;
                do { currentKana = weightedPool[Math.floor(Math.random() * weightedPool.length)]; } while (currentKana === state.lastKana && weightedPool.length > 1);
                state.lastKana = currentKana;
                const r = romajiMap[currentKana], i = new Set; while (i.size < 2) { const rand = Object.values(romajiMap)[Math.floor(Math.random() * Object.values(romajiMap).length)]; if (rand !== r) i.add(rand); }
                const o = [r, ...i].sort(() => 0.5 - Math.random());
                displayQuestion(currentKana, o);
            }

            function displayQuestion(kana, options) {
                state.isAnswering = false;
                charDisplay.textContent = kana;
                updateProgressBar(kana);
                optionsContainer.innerHTML = '';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = opt;
                    btn.dataset.kana = kana;
                    btn.dataset.romaji = opt;
                    btn.addEventListener('click', handleAnswer);
                    optionsContainer.appendChild(btn);
                });
                if (state.progress[kana] === 0) {
                    speak(kana);
                    const correctBtn = optionsContainer.querySelector(`[data-romaji="${romajiMap[kana]}"]`);
                    if (correctBtn) correctBtn.classList.add('highlight');
                }
            }

            function handleAnswer(event) {
                if (state.isAnswering) return;
                state.isAnswering = true;
                const selectedBtn = event.target, currentKana = selectedBtn.dataset.kana, correctRomaji = romajiMap[currentKana], correctBtn = optionsContainer.querySelector(`[data-romaji="${correctRomaji}"]`);
                document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
                if (selectedBtn.dataset.romaji === correctRomaji) {
                    selectedBtn.classList.add('correct');
                    state.progress[currentKana] = Math.min(10, state.progress[currentKana] + 1);
                    unlockNextKana(); // Check if we can unlock a new character
                } else {
                    selectedBtn.classList.add('incorrect');
                    correctBtn.classList.add('correct');
                    state.progress[currentKana] = Math.max(0, state.progress[currentKana] - 1);
                }
                speak(currentKana);
                updateProgressBar(currentKana);
                saveProgress();
                setTimeout(generateQuestion, 1500);
            }
            
            const updateProgressBar = kana => { progressBar.innerHTML = '★'.repeat(state.progress[kana]) + '☆'.repeat(10 - state.progress[kana]); };
            
            const openProgressModal = () => {
                progressTableBody.innerHTML = '';
                allKana.forEach(kana => {
                    const stars = state.progress[kana];
                    const row = `<tr><td class="kana-char">${kana}</td><td>${romajiMap[kana]}</td><td class="star-display">${'★'.repeat(stars)}${'☆'.repeat(10 - stars)}</td></tr>`;
                    progressTableBody.innerHTML += row;
                });
                modalOverlay.classList.add('visible');
            };

            // --- INITIALIZATION ---
            function init() {
                loadProgress();
                updateOverallProgress();
                startBtn.addEventListener('click', showQuizPage);
                utilityMenuBtn.addEventListener('click', showMenuPage);
                utilityProgressBtn.addEventListener('click', openProgressModal);
                closeModalBtn.addEventListener('click', () => modalOverlay.classList.remove('visible'));
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.classList.remove('visible'); });
                showMenuPage();
            }
            
            init();
        });
    </script>
</body>
</html>
